# 编译动态库并链接测试程序

## 方式一：使用 Cmake 

### 1. 创建项目目录结构

```bash
cd 项目目录
# 创建必要的目录
mkdir include build
# 将头文件移动到 include
mv *.h include
# 创建CMakeLists.txt
touch CMakeLists.txt
```



### 2. 创建 CMakeLists.txt

```bash
cmake_minimum_required(VERSION 3.10)
project(ThreadPool)

# 设置 C++ 标准
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 设置库输出目录
set(LIBRARY_OUTPUT_PATH ${CMAKE_BINARY_DIR}/lib)
set(EXECUTABLE_OUTPUT_PATH ${CMAKE_BINARY_DIR}/bin)

# 创建动态库
add_library(thread_pool SHARED
    thread_pool.cpp
)

# 设置头文件目录
target_include_directories(thread_pool PUBLIC
    ${CMAKE_SOURCE_DIR}/include
)

# 链接 pthread 库
find_package(Threads REQUIRED)
target_link_libraries(thread_pool PRIVATE Threads::Threads)

# 创建测试程序
add_executable(thread_pool_test
    test_thread_pool.cpp
)

# 链接线程池库
target_link_libraries(thread_pool_test PRIVATE thread_pool)

# 设置安装规则（可选）
install(TARGETS thread_pool DESTINATION lib)
install(FILES include/thread_pool.h DESTINATION include)
install(TARGETS thread_pool_test DESTINATION bin)
```



### 3. 构建项目

```shell
# 创建并进入构建目录
mkdir -p build
cd build

# 生成构建系统（Debug 版本，适合调试）
cmake .. -DCMAKE_BUILD_TYPE=Debug

# 或者生成 Release 版本
# cmake .. -DCMAKE_BUILD_TYPE=Release

# 编译项目
cmake --build . --parallel $(nproc)
```



### 4. 运行调试程序

```bash
# 设置动态库路径
export LD_LIBRARY_PATH=./lib:$LD_LIBRARY_PATH

# 运行测试程序
./bin/thread_pool_test
```



### 5. 项目结构示例

```
thread_pool/
├── include/
│   └── thread_pool.h
├── src/               # 可选：如果源文件多可以创建
│   ├── thread_pool.cpp
│   └── test_thread_pool.cpp
├── build/
│   ├── bin/
│   │   └── thread_pool_test
│   └── lib/
│       └── libthread_pool.so
└── CMakeLists.txt
```



## 方式二：手动编译

#### 1. 编译动态库

```bash
g++ -fPIC -c thread_pool.cpp -o thread_pool.o -std=c++17 -Iinclude
g++ -shared -o libthread_pool.so thread_pool.o -lpthread
```



#### 2. 编译测试程序

```bash
g++ test_thread_pool.cpp -o thread_pool_test -std=c++17 -Iinclude -L. -lthread_pool
```



#### 3. 运行测试

```bash
# 设置动态库路径
export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH

# 运行程序
./thread_pool_test
```



## 常见问题解决

### 问题1：运行时找不到动态库

```bash
# 永久解决方案（开发期间）
echo "export LD_LIBRARY_PATH=$(pwd)/build/lib:\$LD_LIBRARY_PATH" >> ~/.bashrc
source ~/.bashrc

# 或者安装到系统
sudo cp build/lib/libthread_pool.so /usr/local/lib/
sudo ldconfig
```



### 问题2：头文件找不到

```bash
target_include_directories(thread_pool PUBLIC
    ${CMAKE_SOURCE_DIR}/include
)
```



## 调试建议

```bash
# 使用 GDB 调试
gdb --args ./bin/thread_pool_test

# 在 GDB 中
(gdb) break main
(gdb) run
(gdb) thread apply all bt  # 查看所有线程堆栈
```



